---
- name: Deploy Research Journal Management to Kubernetes
  hosts: localhost
  connection: local
  gather_facts: no
  
  vars:
    k8s_manifests_dir: "../k8s"
    namespace: default
  
  tasks:
    - name: Check if Minikube is running
      command: minikube status
      register: minikube_status
      ignore_errors: yes
      
    - name: Start Minikube if not running
      command: minikube start --driver=docker
      when: minikube_status.rc != 0
      
    - name: Load backend image into Minikube
      command: minikube image load researchjournalmanagement-backend:latest
      ignore_errors: yes
      
    - name: Load frontend image into Minikube
      command: minikube image load researchjournalmanagement-frontend:latest
      ignore_errors: yes
      
    - name: Deploy MySQL to Kubernetes
      command: kubectl apply -f {{ k8s_manifests_dir }}/mysql-deployment.yml
      
    - name: Wait for MySQL to be ready
      command: kubectl wait --for=condition=ready pod -l app=mysql --timeout=300s
      
    - name: Deploy Backend to Kubernetes
      command: kubectl apply -f {{ k8s_manifests_dir }}/backend-deployment.yml
      
    - name: Wait for Backend to be ready
      command: kubectl wait --for=condition=ready pod -l app=backend --timeout=300s
      
    - name: Deploy Frontend to Kubernetes
      command: kubectl apply -f {{ k8s_manifests_dir }}/frontend-deployment.yml
      
    - name: Wait for Frontend to be ready
      command: kubectl wait --for=condition=ready pod -l app=frontend --timeout=300s
      
    - name: Get all pods status
      command: kubectl get pods
      register: pods_status
      
    - name: Display pods status
      debug:
        msg: "{{ pods_status.stdout_lines }}"
        
    - name: Get all services
      command: kubectl get services
      register: services_status
      
    - name: Display services
      debug:
        msg: "{{ services_status.stdout_lines }}"
        
    - name: Get frontend URL
      command: minikube service frontend --url
      register: frontend_url
      ignore_errors: yes
      
    - name: Display frontend URL
      debug:
        msg: "Frontend is accessible at: {{ frontend_url.stdout }}"
      when: frontend_url.rc == 0